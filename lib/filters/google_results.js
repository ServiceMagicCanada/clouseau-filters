// Generated by CoffeeScript 1.4.0
var URL, cheerio, fetchGoogleResults, invoke;

URL = require('url');

invoke = require('ouija');

cheerio = require('cheerio');

fetchGoogleResults = function(query, callback) {
  var resultsurl;
  query = encodeURIComponent(query);
  resultsurl = "https://www.google.ca/search?q=" + query + "&cad=h";
  return invoke(resultsurl, ['html'], function(error, html) {
    var $, data;
    if (error) {
      return callback(error);
    }
    try {
      $ = cheerio.load(html);
      data = $('li.g').map(function() {
        var $it;
        $it = $(this);
        return {
          title: $it.find('.r').text(),
          desc: $it.find('.st').text(),
          source: $it.find('.r a').attr('href')
        };
      });
    } catch (error) {
      return callback(error);
    }
    return callback(null, {
      google_results: data
    });
  });
};

module.exports = {
  validate: function(object, meta) {
    return object.name && object.location && object.location.country;
  },
  filter: function(object, meta, callback) {
    var query;
    query = [object.name, object.location.country].join(', ');
    return fetchGoogleResults(query, callback);
  }
};
